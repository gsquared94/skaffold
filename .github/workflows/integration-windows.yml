name: release (windows)

on:
  push:
    branches: [ master ]

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: integration-tests
  GKE_ZONE: us-central1-a
  GCP_ONLY: true

jobs:

  build:
    name: Release binary gke-only integration tests
    runs-on: windows-latest
    steps:

    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.13
      id: go

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
      
    # Setup gcloud CLI
    - uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
      with:
        version: '290.0.1'
        service_account_key: ${{ secrets.GKE_SA_KEY }}
        project_id: ${{ secrets.GKE_PROJECT }}

    # Configure Docker to use the gcloud command-line tool as a credential
    - name: Configure docker and kubectl
      shell: cmd
      run: |
        gcloud --quiet auth configure-docker
        gcloud container clusters get-credentials "$GKE_CLUSTER" -z "$GKE_ZONE"
        
    - name: Install Kustomize
      run: choco install -ydf Kustomize

    - name: Install Skaffold release binary
      shell: cmd
      run: |
        curl -Lo skaffold.exe https://storage.googleapis.com/skaffold/builds/latest/skaffold-windows-amd64.exe
        move skaffold.exe C:\Windows\system32\skaffold.exe

    - name: Run integration tests
      env:
        TOKEN: ${{ secrets.TOKEN }}
      run: make integration-tests    
